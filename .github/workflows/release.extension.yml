name: Release Extension

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
    paths:
      - "browser-extension/**"

jobs:
  versioning:
    # Skip if triggered by main push but not a tag (paths filter doesn't apply to tags)
    if: github.ref_type == 'tag' || (github.ref == 'refs/heads/main' && !startsWith(github.ref, 'refs/tags/'))
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Version
        id: set-version
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG="${{ github.ref_name }}"
            echo "Triggered by tag: $TAG"
            # Strip 'v' prefix for npm version compatibility
            echo "version=${TAG#v}" >> $GITHUB_OUTPUT
          else
            echo "Triggered by push to main. Calculating next version..."
            LATEST_RELEASE=$(gh release list --limit 1 --json tagName --jq '.[0].tagName')
            
            if [ -z "$LATEST_RELEASE" ]; then
              echo "No previous release found. Starting at 0.0.1"
              echo "version=0.0.1" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "Latest release: $LATEST_RELEASE"
            
            # Remove 'v' prefix and parse
            VERSION_NO_V=${LATEST_RELEASE#v}
            IFS='.' read -r -a parts <<< "$VERSION_NO_V"
            MAJOR=${parts[0]}
            MINOR=${parts[1]}
            PATCH=${parts[2]}
            
            # Increment patch version
            NEW_PATCH=$((PATCH + 1))
            NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
            
            echo "New version: $NEW_VERSION"
            echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          fi

  package:
    needs: versioning
    uses: ./.github/workflows/package.extension.yml
    with:
      version: ${{ needs.versioning.outputs.version }}

  release:
    needs: [versioning, package]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: extension-${{ needs.versioning.outputs.version }}
          path: dist

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.versioning.outputs.version }}
          name: v${{ needs.versioning.outputs.version }}
          files: dist/**/*.zip
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to Web Store
        uses: PlasmoHQ/bpp@v3
        with:
          keys: ${{ secrets.SUBMIT_KEYS }}
          artifact: dist/**/*.zip
